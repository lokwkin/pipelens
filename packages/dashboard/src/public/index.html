<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pipeline Execution Dashboard</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts - JetBrains Mono for code and technical data, Inter for main text -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Custom CSS -->
  <style>
    :root {
      --primary: #2c6e9b;
      --primary-dark: #1e5378;
      --sidebar-bg: #2c3e50;
      --sidebar-width: 250px;
      --border-color: #dde2e7;
      --code-bg: #f5f7fa;
      --success: #2e7d32;
      --error: #d32f2f;
      --warning: #ed6c02;
      --text-primary: #37474f;
      --text-secondary: #546e7a;
      --bg-light: #f5f7fa;
      --card-bg: #ffffff;
      --font-size-base: 0.875rem;      /* Base font size - 14px */
      --font-size-sm: 0.8125rem;       /* Small font size - 13px */
      --font-size-xs: 0.75rem;         /* Extra small - 12px */
      --font-size-lg: 0.9375rem;       /* Large - 15px */
      --font-size-xl: 1.0625rem;       /* Extra large - 17px */
    }
    
    body {
      background-color: var(--bg-light);
      font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color: var(--text-primary);
      overflow-x: hidden;
      font-size: var(--font-size-base);
    }
    
    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--sidebar-bg);
      color: white;
      position: fixed;
      height: 100vh;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 1.25rem 1.25rem 1.25rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-header h1 {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: #f8fafc;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
    }
    
    /* Pipeline selector in sidebar */
    .pipeline-selector {
      margin-top: 0.75rem;
    }
    
    .pipeline-selector select {
      background-color: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: var(--font-size-xs);
      width: 100%;
      padding: 0.375rem 2.25rem 0.375rem 0.75rem;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
      appearance: none;
    }
    
    .pipeline-selector select:focus {
      box-shadow: 0 0 0 0.25rem rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.3);
    }
    
    .pipeline-selector select option {
      background-color: var(--sidebar-bg);
      color: white;
    }
    
    /* Sidebar navigation */
    nav {
      flex: 1;
      padding: 1.25rem 0;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.7);
      border-left: 3px solid transparent;
      padding: 0.625rem 1.25rem;
      transition: all 0.2s ease;
      font-size: var(--font-size-sm);
      letter-spacing: 0.3px;
    }
    
    .nav-link:hover {
      color: white;
      background-color: rgba(255,255,255,0.08);
    }
    
    .nav-link.active {
      color: white;
      background-color: rgba(255,255,255,0.08);
      border-left: 3px solid var(--primary);
    }
    
    .nav-link i {
      width: 20px;
      text-align: center;
      margin-right: 8px;
    }
    
    /* Sidebar footer with auto-refresh controls */
    .sidebar-footer {
      padding: 1.25rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: auto; /* Push to bottom */
      background-color: var(--sidebar-bg); /* Ensure it has background */
    }
    
    .auto-refresh-controls {
      color: rgba(255,255,255,0.8);
      font-size: var(--font-size-xs);
    }
    
    .auto-refresh-controls .form-check-input {
      background-color: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }
    
    .auto-refresh-controls .form-check-input:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .auto-refresh-controls select {
      background-color: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: var(--font-size-xs);
      width: 100%;
      padding: 0.375rem 2.25rem 0.375rem 0.75rem;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
      appearance: none;
      transition: all 0.2s ease;
    }
    
    .auto-refresh-controls select:focus {
      box-shadow: 0 0 0 0.25rem rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.3);
    }
    
    .auto-refresh-controls select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23aaaaaa' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
      border-color: rgba(255,255,255,0.1);
    }
    
    .auto-refresh-controls select option {
      background-color: var(--sidebar-bg);
      color: white;
    }
    
    .refresh-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--success);
      margin-right: 5px;
    }
    
    .refresh-indicator.active {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    
    /* Content area */
    .content-area {
      margin-left: var(--sidebar-width);
      padding: 1.5rem;
      width: calc(100% - var(--sidebar-width));
      max-width: 100%;
    }
    
    /* Cards */
    .card {
      border: none;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
      background-color: var(--card-bg);
    }
    
    .card-header {
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 1.25rem;
      font-weight: 600;
      font-size: var(--font-size-sm);
    }
    
    .card-body {
      padding: 1.25rem;
    }
    
    /* Tables */
    .table {
      margin-bottom: 0;
      font-size: var(--font-size-sm);
    }
    
    .table th {
      font-weight: 600;
      color: var(--text-primary);
      border-top: none;
      background-color: var(--bg-light);
      padding: 0.625rem 0.875rem;
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table td {
      vertical-align: middle;
      padding: 0.625rem 0.875rem;
      border-color: var(--border-color);
    }
    
    /* Clickable rows */
    tr[data-target] {
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    
    tr[data-target]:hover {
      background-color: rgba(44, 110, 155, 0.04);
    }
    
    /* Details row specific styles */
    .details-row {
      background-color: transparent !important;
      cursor: default !important;
    }
    
    .details-row:hover {
      background-color: transparent !important;
    }
    
    /* Status indicators */
    .status-success {
      color: var(--success);
      font-weight: 500;
    }
    
    .status-error {
      color: var(--error);
      font-weight: 500;
    }
    
    .status-running {
      color: var(--warning);
      font-weight: 500;
    }
    
    /* Step details */
    .step-details {
      background-color: var(--bg-light);
      border-radius: 4px;
      padding: 1rem;
      margin-top: 0.5rem;
    }
    
    .detail-section {
      margin-bottom: 1rem;
    }
    
    .detail-section:last-child {
      margin-bottom: 0;
    }
    
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .detail-header h4 {
      font-size: var(--font-size-xs);
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }
    
    .copy-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: background-color 0.15s ease;
    }
    
    .copy-btn:hover {
      background-color: rgba(44, 110, 155, 0.08);
    }
    
    .detail-content textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: white;
      font-family: 'JetBrains Mono', 'Roboto Mono', 'Consolas', 'Courier New', monospace;
      font-size: var(--font-size-xs);
      line-height: 1.4;
      resize: vertical;
      white-space: pre;
      overflow-x: auto;
      color: var(--text-primary);
    }
    
    /* Form elements */
    .form-select, .form-control {
      border-color: var(--border-color);
      font-size: var(--font-size-sm);
    }
    
    .form-select:focus, .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(44, 110, 155, 0.15);
    }
    
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
    }
    
    .btn-outline-secondary {
      color: var(--text-secondary);
      border-color: var(--border-color);
    }
    
    .btn-outline-secondary:hover {
      background-color: var(--bg-light);
      color: var(--text-primary);
    }
    
    /* Section Headers */
    .section-header {
      margin: 1.5rem 0 1rem 0;
    }
    
    .section-header h3 {
      font-size: var(--font-size-lg);
      color: var(--text-primary);
      margin: 0;
      font-weight: 600;
    }
    
    /* Run detail title */
    #run-detail-title {
      font-size: var(--font-size-lg);
      font-weight: 500;
      color: var(--text-primary);
    }
    
    /* Gantt chart */
    .gantt-placeholder {
      background-color: white;
      border-radius: 4px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    /* Views */
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      
      .content-area {
        margin-left: 0;
        width: 100%;
        padding: 1.5rem;
      }
    }
    
    /* Step name link */
    .step-name-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    
    .step-name-link:hover {
      text-decoration: underline;
    }
    
    /* Expand icon */
    .expand-icon {
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }
    
    tr[data-target] .expand-icon.fa-chevron-up {
      transform: rotate(180deg);
    }
    
    /* Global date range selector */
    .global-date-range-selector {
      background-color: white;
      border-radius: 4px;
      padding: 0.625rem 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    
    .global-date-range-selector #page-title {
      font-size: var(--font-size-lg);
      margin-right: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .global-date-range-selector .form-control,
    .global-date-range-selector .form-select {
      border-color: var(--border-color);
      font-size: var(--font-size-xs);
      padding: 0.25rem 0.5rem;
      height: calc(1.5em + 0.5rem + 2px);
    }
    
    .global-date-range-selector .form-control:focus,
    .global-date-range-selector .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(44, 110, 155, 0.15);
    }
    
    @media (max-width: 1200px) {
      .global-date-range-selector .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
      }
      
      .global-date-range-selector #page-title {
        margin-bottom: 0.75rem;
      }
      
      .global-date-range-selector .d-flex .d-flex {
        flex-direction: row;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
    }
    
    @media (max-width: 992px) {
      .global-date-range-selector .d-flex .d-flex {
        gap: 0.5rem;
      }
    }
    
    /* Stats display */
    #step-stats-summary .h4 {
      font-size: var(--font-size-lg);
    }
    
    #step-stats-summary .h5 {
      font-size: var(--font-size-base);
    }
    
    #step-stats-summary .small {
      font-size: var(--font-size-xs);
    }
    
    /* Step analysis view */
    #step-analysis-view h4 {
      font-size: var(--font-size-base);
    }
    
    #step-analysis-details {
      font-size: var(--font-size-xs);
    }
    
    /* Gantt chart container */
    .gantt-placeholder h5 {
      font-size: var(--font-size-sm);
    }
    
    /* Button sizes */
    .btn-sm {
      font-size: var(--font-size-xs);
      padding: 0.25rem 0.5rem;
    }
  </style>
  <!-- Add Flatpickr CSS in the head section -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
  <div class="main-content">
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>StepsTrack Portal</h1>
        
        <!-- Pipeline Selector in Sidebar -->
        <div class="pipeline-selector mt-3">
          <select id="global-pipeline-select" class="form-select form-select-sm">
            <option value="">Select a pipeline</option>
          </select>
        </div>
      </div>
      <nav>
        <a href="#" class="nav-link active" data-view="runs-view">
          <i class="fas fa-stream"></i> Pipeline Runs
        </a>
        <a href="#" class="nav-link" data-view="step-stats-view">
          <i class="fas fa-list-ul"></i> Step Execution Stats
        </a>
      </nav>
      
      <!-- Global Auto-refresh Controls -->
      <div class="sidebar-footer">
        <div class="auto-refresh-controls">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="global-auto-refresh">
            <label class="form-check-label" for="global-auto-refresh">
              <span class="refresh-indicator me-1"></span>
              Auto-refresh
            </label>
          </div>
          <select id="global-refresh-interval" class="form-select form-select-sm mt-2" disabled>
            <option value="3000">3 sec</option>
            <option value="10000">10 sec</option>
            <option value="30000">30 sec</option>
            <option value="60000">1 min</option>
          </select>
        </div>
      </div>
    </div>
    
    <div class="content-area">
      <!-- Global Date Range Selector -->
      <div class="global-date-range-selector">
        <div class="d-flex align-items-center justify-content-between">
          <!-- Page Title - Will be dynamically updated based on current view -->
          <h1 id="page-title" class="h5 mb-0">Pipeline Runs</h1>
          
          <!-- Date Range Controls -->
          <div class="d-flex align-items-center">
            <label for="global-time-preset-select" class="me-2 mb-0">Range:</label>
            <select id="global-time-preset-select" class="form-select form-select-sm me-3" style="width: auto;">
              <option value="custom">Custom</option>
              <option value="5">Last 5 minutes</option>
              <option value="15">Last 15 minutes</option>
              <option value="30">Last 30 minutes</option>
              <option value="60">Last 1 hour</option>
              <option value="360">Last 6 hours</option>
              <option value="720">Last 12 hours</option>
              <option value="1440">Last 24 hours</option>
              <option value="2880">Last 2 days</option>
              <option value="10080">Last 7 days</option>
              <option value="43200">Last 30 days</option>
            </select>
            <label for="global-start-date" class="me-2 mb-0">From:</label>
            <input type="text" id="global-start-date" class="form-control form-control-sm me-3" style="width: 160px;">
            <label for="global-end-date" class="me-2 mb-0">To:</label>
            <input type="text" id="global-end-date" class="form-control form-control-sm me-3" style="width: 160px;">
            <button id="global-apply-filter" class="btn btn-primary btn-sm">Apply</button>
          </div>
        </div>
      </div>
      
      <!-- Runs View -->
      <div id="runs-view" class="view active">
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table id="runs-table" class="table table-hover">
                <thead>
                  <tr>
                    <th>Run ID</th>
                    <th>Pipeline</th>
                    <th>Start Time (UTC)</th>
                    <th>End Time (UTC)</th>
                    <th>Duration</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="6" class="text-center py-4">Select a pipeline to view runs</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Run Detail View -->
      <div id="run-detail-view" class="view">
        <div class="card">
          <div class="card-body">
            <button id="back-to-runs" class="btn btn-outline-secondary mb-4">
              <i class="fas fa-arrow-left me-1"></i> Back to Runs
            </button>
            
            <!-- Gantt Chart -->
            <div class="gantt-placeholder p-4 text-center bg-light rounded mb-4">
              <h5 class="text-muted">Loading Gantt Chart...</h5>
            </div>
            
            <!-- Steps Table -->
            <div class="section-header">
              <h3 id="steps-count">Steps: 0</h3>
            </div>
            
            <div class="table-responsive">
              <table id="steps-table" class="table">
                <thead>
                  <tr>
                    <th>Step Key</th>
                    <th>Step Name</th>
                    <th>Start Time (UTC)</th>
                    <th>End Time (UTC)</th>
                    <th>Duration</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" class="text-center py-4">Loading steps...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Step Listing View -->
      <div id="step-stats-view" class="view">
        <div class="card">
          <div class="card-body">
            <div class="mb-4 pb-3 border-bottom">
              <div class="row align-items-center mb-3">
                <div class="col-12">
                  <div class="d-flex flex-wrap align-items-center">
                    <!-- <label for="step-name-select" class="me-2">Step:</label> -->
                    <select id="step-name-select" class="form-select me-3" style="width: auto;">
                      <option value="">Select a step</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Add step name title here -->
            <div id="step-stats-title" class="mb-4 d-none">

            </div>
            
            <!-- Step Statistics Summary -->
            <div id="step-stats-summary" class="mb-4 d-none">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <div class="card bg-light">
                    <div class="card-body p-3">
                      <h5 class="card-title h6 font-weight-normal">Execution Count</h5>
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <span id="stats-total-executions" class="h4 mb-0">0</span> total
                        </div>
                        <div class="text-end">
                          <span id="stats-success-count" class="text-success">0</span> success<br>
                          <span id="stats-error-count" class="text-danger">0</span> errors
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-8 mb-3">
                  <div class="card bg-light">
                    <div class="card-body p-3">
                      <h5 class="card-title h6 font-weight-normal">Duration Statistics</h5>
                      <div class="row">
                        <div class="col-md-4">
                          <div class="text-muted small">Average</div>
                          <div id="stats-avg-duration" class="h5 mb-0">0ms</div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-muted small">Minimum</div>
                          <div id="stats-min-duration" class="h5 mb-0">0ms</div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-muted small">Maximum</div>
                          <div id="stats-max-duration" class="h5 mb-0">0ms</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Step Time Series Chart -->
            <div id="step-time-series-chart-container" class="mb-4 d-none">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title h6 font-weight-normal mb-3">Performance Over Time</h5>
                  <div id="step-time-series-chart" style="width: 100%; height: 400px;"></div>
                </div>
              </div>
            </div>
            
            <div class="table-responsive">
              <table id="step-stats-table" class="table table-hover">
                <thead>
                  <tr>
                    <th>Timestamp (UTC)</th>
                    <th>Run ID</th>
                    <th>Step Key</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="4" class="text-center py-4">Select a pipeline and step to view instances</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Step Analysis View -->
      <div id="step-analysis-view" class="view">
        <div class="card">
          <div class="card-body">
            <button id="back-to-run-detail" class="btn btn-outline-secondary mb-4">
              <i class="fas fa-arrow-left me-1"></i> Back to Run Detail
            </button>
            
            <div class="step-analysis-content">
              <h4 class="mb-3">Performance Over Time</h4>
              <div class="chart-placeholder p-4 text-center bg-light rounded mb-4">
                <p class="text-muted mb-0">Performance chart will be implemented here</p>
              </div>
              
              <h4 class="mb-3">Step Details</h4>
              <pre id="step-analysis-details" class="bg-light p-3 rounded"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // State management
    const state = {
      currentView: 'runs-view',
      selectedPipeline: null,
      selectedRun: null,
      selectedStep: null,
      selectedStepName: null,
      autoRefresh: false,
      refreshInterval: null,
      refreshFrequency: 3000,
      expandedRows: new Set(), // Track expanded rows
      globalDateRange: {
        startDate: null,
        endDate: null,
        timePreset: "1440" // Default to last 24 hours
      }
    };

    // DOM Elements
    const navLinks = document.querySelectorAll('.nav-link');
    const views = document.querySelectorAll('.view');
    const globalPipelineSelect = document.getElementById('global-pipeline-select');
    const stepNameSelect = document.getElementById('step-name-select');
    const runsTable = document.getElementById('runs-table').querySelector('tbody');
    const stepsTable = document.getElementById('steps-table').querySelector('tbody');
    const stepStatsTable = document.getElementById('step-stats-table').querySelector('tbody');
    const backToRunsBtn = document.getElementById('back-to-runs');
    const backToRunDetailBtn = document.getElementById('back-to-run-detail');
    const pageTitle = document.getElementById('page-title');
    const stepAnalysisDetails = document.getElementById('step-analysis-details');
    const globalAutoRefreshCheckbox = document.getElementById('global-auto-refresh');
    const globalRefreshIntervalSelect = document.getElementById('global-refresh-interval');
    const refreshIndicator = document.querySelector('.refresh-indicator');

    // Helper functions
    // Format date to YYYY-MM-DD HH:mm:ss format for datetime-local inputs
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      
      // For datetime-local inputs, the format must be YYYY-MM-DDThh:mm:ss
      return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }

    // Format date to YYYY-MM-DD HH:mm:ss format for display
    function formatDateTime(timestamp) {
      if (!timestamp) return 'N/A';
      
      const date = new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function formatDuration(ms) {
      if (!ms) return 'N/A';
      
      const totalMs = ms % 1000;
      const seconds = Math.floor(ms / 1000) % 60;
      const minutes = Math.floor(ms / (1000 * 60)) % 60;
      const hours = Math.floor(ms / (1000 * 60 * 60));
      
      // If duration is less than 10 seconds, display only milliseconds
      if (hours === 0 && minutes === 0 && seconds < 10) {
        return `${ms}ms`;
      }
      
      if (hours > 0) {
        return `${hours}h ${minutes}m ${seconds}s ${totalMs}ms`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds}s ${totalMs}ms`;
      } else {
        return `${seconds}s ${totalMs}ms`;
      }
    }

    // Navigation functions
    function showView(viewId) {
      // Update active link
      navLinks.forEach(l => l.classList.remove('active'));
      document.querySelector(`.nav-link[data-view="${viewId}"]`)?.classList.add('active');
      
      // Show selected view
      views.forEach(view => {
        view.classList.remove('active');
        if (view.id === viewId) {
          view.classList.add('active');
          state.currentView = viewId;
          
          // Update page title based on current view
          if (viewId === 'runs-view') {
            pageTitle.textContent = 'Pipeline Runs';
          } else if (viewId === 'step-stats-view') {
            pageTitle.textContent = 'Step Execution Stats';
          }
          
          // Load data based on the current view and selected pipeline
          if (state.selectedPipeline) {
            if (viewId === 'runs-view') {
              loadRuns(state.selectedPipeline);
            } else if (viewId === 'step-stats-view' && state.selectedStepName) {
              loadStepNames(state.selectedPipeline).then(() => {
                stepNameSelect.value = state.selectedStepName;
                loadStepTimeSeries(state.selectedPipeline, state.selectedStepName);
              });
            } else if (viewId === 'step-stats-view') {
              // If we're switching to step stats view but no step is selected,
              // make sure the step names are loaded
              loadStepNames(state.selectedPipeline);
            }
          }
        }
      });
    }

    function showRunDetails(runId) {
      // Reset expanded rows when navigating to a different run
      if (state.selectedRun !== runId) {
        state.expandedRows = new Set();
      }
      
      state.selectedRun = runId;
      
      // Switch to run detail view
      showView('run-detail-view');
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('view', 'run-detail');
      url.searchParams.set('runId', runId);
      window.history.pushState({view: 'run-detail', runId}, '', url);
      
      // Update page title
      pageTitle.textContent = `Run Details: ${runId}`;
      
      // Load run details (not an auto-refresh)
      loadRunDetails(runId, false);
    }
    
    function showStepAnalysis(step) {
      state.selectedStep = step;
      
      // Switch to step analysis view
      showView('step-analysis-view');
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('view', 'step-analysis');
      url.searchParams.set('runId', state.selectedRun);
      url.searchParams.set('stepKey', step.key);
      window.history.pushState({view: 'step-analysis', runId: state.selectedRun, stepKey: step.key}, '', url);
      
      // Update page title
      pageTitle.textContent = `Step Analysis: ${step.name}`;
      
      // Update details
      stepAnalysisDetails.innerHTML = `
        <p><strong>Step Key:</strong> ${step.key}</p>
        <p><strong>Start Time:</strong> ${formatDateTime(step.time.startTs)}</p>
        <p><strong>End Time:</strong> ${formatDateTime(step.time.endTs)}</p>
        <p><strong>Duration:</strong> ${formatDuration(step.time.timeUsageMs)}</p>
      `;
    }

    // Navigation
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const viewId = link.getAttribute('data-view');
        
        showView(viewId);
        
        // Update URL
        const url = new URL(window.location);
        url.searchParams.set('view', viewId);
        
        // Clear other parameters if going to main views
        if (viewId === 'runs-view') {
          url.searchParams.delete('runId');
          url.searchParams.delete('stepKey');
          url.searchParams.delete('stepName');
        } else if (viewId === 'step-stats-view') {
          url.searchParams.delete('runId');
          url.searchParams.delete('stepKey');
          // Keep stepName if it exists in state
          if (state.selectedStepName) {
            url.searchParams.set('stepName', state.selectedStepName);
          }
        }
        
        window.history.pushState({view: viewId}, '', url);
      });
    });

    // Back buttons
    backToRunsBtn.addEventListener('click', (e) => {
      e.preventDefault();
      showView('runs-view');
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('view', 'runs-view');
      url.searchParams.delete('runId');
      url.searchParams.delete('stepKey');
      window.history.pushState({view: 'runs-view'}, '', url);
      
      // Reset expanded rows state when exiting run detail view
      state.expandedRows = new Set();
      state.selectedRun = null;
    });

    backToRunDetailBtn.addEventListener('click', (e) => {
      e.preventDefault();
      showView('run-detail-view');
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('view', 'run-detail');
      url.searchParams.set('runId', state.selectedRun);
      url.searchParams.delete('stepKey');
      window.history.pushState({view: 'run-detail', runId: state.selectedRun}, '', url);
      
      state.selectedStep = null;
    });

    // Handle browser back/forward buttons
    window.addEventListener('popstate', (event) => {
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');
      const runId = params.get('runId');
      const stepKey = params.get('stepKey');
      
      if (view === 'run-detail' && runId) {
        state.selectedRun = runId;
        showView('run-detail-view');
        // Update page title
        pageTitle.textContent = `Run Details: ${runId}`;
        loadRunDetails(runId, false);
      } else if (view === 'step-analysis' && runId && stepKey) {
        state.selectedRun = runId;
        // We need to find the step data
        fetch(`/api/runs/${runId}/step/${stepKey}`)
          .then(response => response.json())
          .then(step => {
            state.selectedStep = step;
            showView('step-analysis-view');
            // Update page title
            pageTitle.textContent = `Step Analysis: ${step.name}`;
            stepAnalysisDetails.innerHTML = `
              <p><strong>Step Key:</strong> ${step.key}</p>
              <p><strong>Start Time:</strong> ${formatDateTime(step.time.startTs)}</p>
              <p><strong>End Time:</strong> ${formatDateTime(step.time.endTs)}</p>
              <p><strong>Duration:</strong> ${formatDuration(step.time.timeUsageMs)}</p>
            `;
          });
      } else {
        showView(view);
      }
    });

    // Auto-refresh toggles
    globalAutoRefreshCheckbox.addEventListener('change', function() {
      state.autoRefresh = this.checked;
      refreshIndicator.classList.toggle('active', this.checked);
      
      // Enable/disable the refresh interval dropdown based on checkbox state
      globalRefreshIntervalSelect.disabled = !this.checked;
      
      if (this.checked) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    });

    // Refresh interval change handlers
    globalRefreshIntervalSelect.addEventListener('change', function() {
      state.refreshFrequency = parseInt(this.value);
      if (state.autoRefresh) {
        startAutoRefresh();
      }
    });

    // Auto-refresh functions
    function startAutoRefresh() {
      stopAutoRefresh(); // Clear any existing interval
      
      state.refreshInterval = setInterval(() => {
        if (state.selectedRun && state.currentView === 'run-detail-view') {
          // Save expanded state before auto-refresh
          const expandedRows = new Set();
          document.querySelectorAll('.details-row').forEach(row => {
            if (row.style.display !== 'none') {
              expandedRows.add(row.id);
            }
          });
          state.expandedRows = expandedRows;
          
          // Pass true to indicate this is an auto-refresh
          loadRunDetails(state.selectedRun, true);
        } else if (state.selectedPipeline && state.currentView === 'runs-view') {
          loadRuns(state.selectedPipeline);
        } else if (state.selectedPipeline && state.selectedStepName && state.currentView === 'step-stats-view') {
          loadStepTimeSeries(state.selectedPipeline, state.selectedStepName);
        }
      }, state.refreshFrequency);
    }

    function stopAutoRefresh() {
      if (state.refreshInterval) {
        clearInterval(state.refreshInterval);
        state.refreshInterval = null;
      }
    }

    // Process time series data for chart visualization
    function processTimeSeriesDataForChart(instances, timeRange) {
      // If no instances, return empty data
      if (!instances || instances.length === 0) {
        return {
          timePoints: [],
          maxDurations: [],
          minDurations: [],
          avgDurations: [],
          successCounts: [],
          errorCounts: []
        };
      }
      
      // Sort instances by timestamp
      instances.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      // Determine start and end times from the data or from timeRange
      let startTime, endTime;
      
      if (timeRange && timeRange.startDate) {
        startTime = new Date(timeRange.startDate).getTime();
      } else {
        startTime = new Date(instances[0].timestamp).getTime();
      }
      
      if (timeRange && timeRange.endDate) {
        endTime = new Date(timeRange.endDate).getTime();
      } else {
        endTime = new Date(instances[instances.length - 1].timestamp).getTime();
      }
      
      // Calculate time interval (divide the range into 30 periods)
      const totalTimeRange = endTime - startTime;
      const intervalMs = Math.max(totalTimeRange / 30, 1000); // At least 1 second
      
      // Create buckets for each time interval
      const buckets = [];
      let currentTime = startTime;
      
      while (currentTime <= endTime) {
        buckets.push({
          startTime: currentTime,
          endTime: currentTime + intervalMs,
          instances: [],
          maxDuration: 0,
          minDuration: Infinity,
          avgDuration: 0,
          successCount: 0,
          errorCount: 0
        });
        currentTime += intervalMs;
      }
      
      // Assign instances to buckets
      instances.forEach(instance => {
        const instanceTime = new Date(instance.timestamp).getTime();
        const bucketIndex = Math.min(
          Math.floor((instanceTime - startTime) / intervalMs),
          buckets.length - 1
        );
        
        if (bucketIndex >= 0 && bucketIndex < buckets.length) {
          buckets[bucketIndex].instances.push(instance);
        }
      });
      
      // Calculate statistics for each bucket
      buckets.forEach(bucket => {
        if (bucket.instances.length > 0) {
          // Calculate duration statistics
          let totalDuration = 0;
          
          bucket.instances.forEach(instance => {
            const duration = instance.duration || 0;
            
            // Update max and min durations
            bucket.maxDuration = Math.max(bucket.maxDuration, duration);
            bucket.minDuration = Math.min(bucket.minDuration, duration);
            
            // Add to total for average calculation
            totalDuration += duration;
            
            // Count successes and errors
            if (instance.error) {
              bucket.errorCount++;
            } else {
              bucket.successCount++;
            }
          });
          
          // Calculate average duration
          bucket.avgDuration = totalDuration / bucket.instances.length;
        }
        
        // If no instances in this bucket, set min to 0 instead of Infinity
        if (bucket.minDuration === Infinity) {
          bucket.minDuration = 0;
        }
      });
      
      // Extract data for chart
      const timePoints = buckets.map(bucket => new Date(bucket.startTime));
      const maxDurations = buckets.map(bucket => bucket.maxDuration);
      const minDurations = buckets.map(bucket => bucket.minDuration);
      const avgDurations = buckets.map(bucket => bucket.avgDuration);
      const successCounts = buckets.map(bucket => bucket.successCount);
      const errorCounts = buckets.map(bucket => bucket.errorCount);
      
      return {
        timePoints,
        maxDurations,
        minDurations,
        avgDurations,
        successCounts,
        errorCounts
      };
    }
    
    // Draw the step time series chart
    function drawStepTimeSeriesChart(chartData) {
      const chartContainer = document.getElementById('step-time-series-chart-container');
      const chartElement = document.getElementById('step-time-series-chart');
      
      // If no data or empty data, hide the chart container and return
      if (!chartData || chartData.timePoints.length === 0) {
        chartContainer.classList.add('d-none');
        return;
      }
      
      // Show the chart container
      chartContainer.classList.remove('d-none');
      
      // Load Google Charts
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);
      
      function drawChart() {
        // Create data table
        const data = new google.visualization.DataTable();
        
        // Add columns
        data.addColumn('datetime', 'Time');
        data.addColumn('number', 'Max Duration (ms)');
        data.addColumn('number', 'Avg Duration (ms)');
        data.addColumn('number', 'Min Duration (ms)');
        data.addColumn('number', 'Success Count');
        data.addColumn('number', 'Error Count');
        
        // Add rows
        const rows = chartData.timePoints.map((time, index) => [
          time,
          chartData.maxDurations[index],
          chartData.avgDurations[index],
          chartData.minDurations[index],
          chartData.successCounts[index],
          chartData.errorCounts[index]
        ]);
        
        data.addRows(rows);
        
        // Set chart options
        const options = {
          height: 400,
          legend: { position: 'top', maxLines: 3 },
          seriesType: 'line',
          series: {
            0: { color: '#d32f2f', lineWidth: 2 }, // Max Duration (red)
            1: { color: '#2c6e9b', lineWidth: 2 }, // Avg Duration (blue)
            2: { color: '#2e7d32', lineWidth: 2 }, // Min Duration (green)
            3: { type: 'bars', color: '#2e7d32', targetAxisIndex: 1 }, // Success Count (green)
            4: { type: 'bars', color: '#d32f2f', targetAxisIndex: 1 }  // Error Count (red)
          },
          isStacked: true,
          vAxes: {
            0: { title: 'Duration (ms)', minValue: 0 },
            1: { title: 'Count', minValue: 0 }
          },
          hAxis: {
            title: 'Time',
            format: 'HH:mm:ss'
          },
          chartArea: {
            width: '80%',
            height: '70%'
          }
        };
        
        // Create and draw the chart
        const chart = new google.visualization.ComboChart(chartElement);
        chart.draw(data, options);
      }
    }

    // API functions
    async function fetchPipelines() {
      try {
        const response = await fetch('/api/pipelines');
        const pipelines = await response.json();
        
        // Populate global pipeline dropdown
        globalPipelineSelect.innerHTML = '<option value="">Select a pipeline</option>';
        
        pipelines.forEach(pipeline => {
          globalPipelineSelect.innerHTML += `<option value="${pipeline}">${pipeline}</option>`;
        });
      } catch (error) {
        console.error('Error fetching pipelines:', error);
        globalPipelineSelect.innerHTML = '<option value="">Error loading pipelines</option>';
      }
    }

    async function loadRuns(pipeline) {
      try {
        // Build query parameters
        let url = `/api/pipelines/${pipeline}/runs`;
        const params = new URLSearchParams();
        
        // Use global date range if available
        if (state.globalDateRange.timePreset !== "custom") {
          // For preset selections, calculate the start date
          const minutes = parseInt(state.globalDateRange.timePreset, 10);
          const now = new Date();
          const start = new Date(now.getTime() - minutes * 60 * 1000);
          params.append('startDate', start.toISOString());
        } else if (state.globalDateRange.startDate || state.globalDateRange.endDate) {
          // For custom range, use the stored values
          if (state.globalDateRange.startDate) {
            const startDate = new Date(state.globalDateRange.startDate).toISOString();
            params.append('startDate', startDate);
          }
          
          if (state.globalDateRange.endDate) {
            const endDate = new Date(state.globalDateRange.endDate).toISOString();
            params.append('endDate', endDate);
          }
        } else {
          // Fallback to the old filter inputs if global date range is not set
          const startDate = document.getElementById('start-date').value;
          const endDate = document.getElementById('end-date').value;
          
          if (startDate) {
            params.append('startDate', startDate);
          }
          
          if (endDate) {
            params.append('endDate', endDate);
          }
        }
        
        if (params.toString()) {
          url += `?${params.toString()}`;
        }
        
        const response = await fetch(url);
        const runs = await response.json();
        
        if (!runs?.length) {
          runsTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">No runs found</td></tr>';
          return;
        }

        runsTable.innerHTML = '';
        runs.forEach(run => {
          const startTime = formatDateTime(run.startTime);
          const endTime = run.endTime ? formatDateTime(run.endTime) : 'In progress';
          const duration = formatDuration(run.duration);
          
          let statusClass = '';
          if (run.status === 'completed') {
            statusClass = 'status-success';
          } else if (run.status === 'failed') {
            statusClass = 'status-error';
          } else if (run.status === 'running') {
            statusClass = 'status-running';
          }
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${run.runId}</td>
            <td>${run.pipeline}</td>
            <td>${startTime}</td>
            <td>${endTime}</td>
            <td>${duration}</td>
            <td class="${statusClass}">${run.status}</td>
          `;
          
          row.addEventListener('click', () => {
            showRunDetails(run.runId);
          });
          
          runsTable.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading runs:', error);
        runsTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Error loading runs</td></tr>';
      }
    }

    async function loadRunDetails(runId, isAutoRefresh = false) {
      try {
        // Only save expanded state if this is an auto-refresh
        if (isAutoRefresh) {
          const expandedRows = new Set();
          document.querySelectorAll('.details-row').forEach(row => {
            if (row.style.display !== 'none') {
              expandedRows.add(row.id);
            }
          });
          state.expandedRows = expandedRows;
        }
        
        // Update page title if not an auto-refresh
        if (!isAutoRefresh) {
          pageTitle.textContent = `Run Details: ${runId}`;
        }
        
        // Load Gantt chart
        loadGanttChart(runId);
        
        // Fetch steps data using the dedicated endpoint
        const stepsResponse = await fetch(`/api/runs/${runId}/steps`);
        const steps = await stepsResponse.json();
        
        // Update steps count
        const stepsCount = steps ? steps.length : 0;
        document.getElementById('steps-count').textContent = `Steps: ${stepsCount}`;
        
        // Load steps
        if (steps && Array.isArray(steps)) {
          stepsTable.innerHTML = '';
          
          steps.forEach((step, index) => {
            const startTime = formatDateTime(step.time.startTs);
            const endTime = formatDateTime(step.time.endTs);
            const duration = formatDuration(step.time.timeUsageMs);
            
            let status = 'Completed';
            let statusClass = 'status-success';
            
            if (step.error) {
              status = 'Error';
              statusClass = 'status-error';
            } else if (step.time.endTs === 0) {
              status = 'Running';
              statusClass = 'status-running';
            }
            
            // Create unique IDs for each row and details section
            const rowId = `step-row-${index}`;
            const detailsId = `step-details-${index}`;
            
            // Main row
            const row = document.createElement('tr');
            row.id = rowId;
            row.setAttribute('data-target', detailsId);
            row.innerHTML = `
              <td>${step.key}</td>
              <td><a href="#" class="step-name-link">${step.name}</a></td>
              <td>${startTime}</td>
              <td>${endTime}</td>
              <td>${duration}</td>
              <td class="${statusClass}">${status}</td>
              <td class="text-end">
                <i class="fas fa-chevron-down expand-icon"></i>
              </td>
            `;
            stepsTable.appendChild(row);
            
            // Details row
            const detailsRow = document.createElement('tr');
            detailsRow.id = detailsId;
            detailsRow.className = 'details-row';
            
            // Check if this row was expanded before refresh
            const wasExpanded = state.expandedRows.has(detailsId);
            detailsRow.style.display = wasExpanded ? 'table-row' : 'none';
            
            // Update expand icon based on expanded state
            if (wasExpanded) {
              row.querySelector('.expand-icon').classList.remove('fa-chevron-down');
              row.querySelector('.expand-icon').classList.add('fa-chevron-up');
            }
            
            // Create the details cell
            const detailsCell = document.createElement('td');
            detailsCell.colSpan = 7;
            
            let detailsContent = '<div class="step-details">';
            
            // Record section
            const recordJson = JSON.stringify(step.record || {}, null, 2);
            detailsContent += `
              <div class="detail-section">
                <div class="detail-header">
                  <h4>Record:</h4>
                  <button class="copy-btn" data-content="${encodeURIComponent(recordJson)}">
                    <i class="fa fa-copy"></i>
                  </button>
                </div>
                <div class="detail-content">
                  <textarea readonly>${recordJson}</textarea>
                </div>
              </div>
            `;
            
            // Result section (if available)
            if (step.result !== undefined) {
              const resultJson = JSON.stringify(step.result, null, 2);
              detailsContent += `
                <div class="detail-section">
                  <div class="detail-header">
                    <h4>Result:</h4>
                    <button class="copy-btn" data-content="${encodeURIComponent(resultJson)}">
                      <i class="fa fa-copy"></i>
                    </button>
                  </div>
                  <div class="detail-content">
                    <textarea readonly>${resultJson}</textarea>
                  </div>
                </div>
              `;
            }
            
            // Error section (if available)
            if (step.error) {
              detailsContent += `
                <div class="detail-section">
                  <div class="detail-header">
                    <h4>Error:</h4>
                    <button class="copy-btn" data-content="${encodeURIComponent(step.error)}">
                      <i class="fa fa-copy"></i>
                    </button>
                  </div>
                  <div class="detail-content">
                    <textarea readonly>${step.error}</textarea>
                  </div>
                </div>
              `;
            }
            
            detailsContent += '</div>';
            detailsCell.innerHTML = detailsContent;
            detailsRow.appendChild(detailsCell);
            stepsTable.appendChild(detailsRow);
            
            // Add step name link functionality
            const stepNameLink = row.querySelector('.step-name-link');
            stepNameLink.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              
              // Instead of showing step analysis, navigate to step stats view
              state.selectedStepName = step.name;
              
              // Update step name select dropdown
              loadStepNames(state.selectedPipeline).then(() => {
                stepNameSelect.value = step.name;
                
                // Load the step time series data
                loadStepTimeSeries(state.selectedPipeline, step.name);
                
                // Switch to step stats view
                showView('step-stats-view');
                
                // Update URL
                const url = new URL(window.location);
                url.searchParams.set('view', 'step-stats-view');
                url.searchParams.set('stepName', step.name);
                url.searchParams.delete('runId');
                url.searchParams.delete('stepKey');
                window.history.pushState({view: 'step-stats-view', stepName: step.name}, '', url);
              });
            });
          });
          
          // Make rows clickable to expand/collapse
          document.querySelectorAll('#steps-table tbody tr:not(.details-row)').forEach(row => {
            row.addEventListener('click', function(e) {
              // Don't trigger if clicking on the step name link
              if (e.target.closest('.step-name-link')) {
                return;
              }
              
              const targetId = this.getAttribute('data-target');
              const detailsRow = document.getElementById(targetId);
              const isExpanded = detailsRow.style.display !== 'none';
              const expandIcon = this.querySelector('.expand-icon');
              
              // Update expanded state in our state object
              if (isExpanded) {
                state.expandedRows.delete(targetId);
                expandIcon.classList.remove('fa-chevron-up');
                expandIcon.classList.add('fa-chevron-down');
              } else {
                state.expandedRows.add(targetId);
                expandIcon.classList.remove('fa-chevron-down');
                expandIcon.classList.add('fa-chevron-up');
              }
              
              detailsRow.style.display = isExpanded ? 'none' : 'table-row';
            });
          });
          
          // Add event listeners for all copy buttons
          document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
              e.stopPropagation(); // Prevent row expansion when clicking copy
              const content = decodeURIComponent(this.getAttribute('data-content'));
              navigator.clipboard.writeText(content).then(() => {
                // Show temporary success message
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fa fa-check"></i>';
                setTimeout(() => {
                  this.innerHTML = originalText;
                }, 2000);
              }).catch(err => {
                console.error('Failed to copy text: ', err);
              });
            });
          });
        } else {
          stepsTable.innerHTML = '<tr><td colspan="7" class="text-center py-4">No steps found</td></tr>';
        }
      } catch (error) {
        console.error('Error loading run details:', error);
        stepsTable.innerHTML = '<tr><td colspan="7" class="text-center py-4">Error loading run details</td></tr>';
      }
    }

    async function loadGanttChart(runId) {
      try {
        const ganttPlaceholder = document.querySelector('.gantt-placeholder');
        
        // Show loading state
        ganttPlaceholder.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading Gantt Chart...</p></div>';
        
        // Fetch the steps data for the run
        const response = await fetch(`/api/runs/${runId}/steps`);
        const steps = await response.json();
        
        if (!steps || !steps.length) {
          ganttPlaceholder.innerHTML = '<div class="alert alert-warning">No steps data available for Gantt Chart</div>';
          return;
        }
        
        // Create a div for the chart
        ganttPlaceholder.innerHTML = `<div id="gantt_chart" style="width: 100%; height: 400px;"></div>`;
        
        // Load the Google Charts visualization library
        google.charts.load('current', {'packages':['gantt']});
        google.charts.setOnLoadCallback(() => {
          drawGanttChart(steps);
        });
        
        function drawGanttChart(steps) {
          const data = new google.visualization.DataTable();
          
          // Add columns
          data.addColumn('string', 'Task ID');
          data.addColumn('string', 'Task Name');
          data.addColumn('string', 'Resource');
          data.addColumn('date', 'Start Date');
          data.addColumn('date', 'End Date');
          data.addColumn('number', 'Duration');
          data.addColumn('number', 'Percent Complete');
          data.addColumn('string', 'Dependencies');
          
          // Compute the minimum start date, used as the overall start date for the Gantt chart
          const ganttStartTs = steps.map(step => step.time.startTs).reduce((a, b) => Math.min(a, b));

          const rows = steps.map(step => {
            // Create start and end dates
            const relativeStartTs = step.time.startTs - ganttStartTs;
            // const relativeEndTs = step.time.endTs - ganttStartTs;
            
            // Handle steps that are still running or failed
            let endDate;
            let percentComplete;
            
            if (step.time.endTs && step.time.endTs > 0) {
              endDate = new Date(step.time.endTs);
              percentComplete = 100; // Completed
            } else {
              // For running steps, use current time as temporary end
              endDate = new Date();
              percentComplete = 50; // In progress
            }
            
            // Determine color based on status
            let resource = 'Success';
            if (step.error) {
              resource = 'Error';
            } else if (!step.time.endTs || step.time.endTs === 0) {
              resource = 'Running';
            }
            
            return [
              step.key, // Task ID
              step.key, // Task Name
              resource, // Resource (used for coloring)
              new Date(relativeStartTs),
              null,
              step.time.timeUsageMs, // Duration (null because we're using start/end dates)
              percentComplete,
              null // Dependencies (we're not showing dependencies)
            ];
          });
          
          data.addRows(rows);
          
          // Set chart options
          const options = {
            height: 400,
            gantt: {
              trackHeight: 30,
              barHeight: 20,
              labelMaxWidth: 300,
              criticalPathEnabled: false,
              percentEnabled: false,
              palette: [
                {
                  color: '#2e7d32', // Success - dark green
                  dark: '#1b5e20', // Darker shade
                  light: '#e8f5e9' // Light shade for hover
                },
                {
                  color: '#d32f2f', // Error - red
                  dark: '#b71c1c',
                  light: '#ffebee'
                },
                {
                  color: '#ed6c02', // Running - orange
                  dark: '#e65100',
                  light: '#fff3e0'
                }
              ]
            }
          };
          
          // Create and draw the chart
          const chart = new google.visualization.Gantt(document.getElementById('gantt_chart'));
          chart.draw(data, options);
        }
      } catch (error) {
        console.error('Error generating Gantt chart:', error);
        document.querySelector('.gantt-placeholder').innerHTML = '<div class="alert alert-danger">Error Generating Gantt Chart</div>';
      }
    }

    async function loadStepNames(pipeline) {
      try {
        const response = await fetch(`/api/pipelines/${pipeline}/steps`);
        const steps = await response.json();
        
        stepNameSelect.innerHTML = '<option value="">Select a step</option>';
        
        steps.forEach(step => {
          stepNameSelect.innerHTML += `<option value="${step}">${step}</option>`;
        });
        
        return steps; // Return the steps for promise chaining
      } catch (error) {
        console.error('Error loading step names:', error);
        stepNameSelect.innerHTML = '<option value="">Error loading steps</option>';
        return []; // Return empty array in case of error
      }
    }

    async function loadStepTimeSeries(pipeline, stepName) {
      try {
        // Update the step name title
        const stepStatsSummary = document.getElementById('step-stats-summary');
        
        if (stepName) {
        } else {
          stepStatsSummary.classList.add('d-none');
        }
        
        // Build query parameters
        let url = `/api/pipelines/${pipeline}/steps/${stepName}/time-series`;
        const params = new URLSearchParams();
        
        // Use global date range if available
        if (state.globalDateRange.timePreset !== "custom") {
          // For preset selections, calculate the start date
          const minutes = parseInt(state.globalDateRange.timePreset, 10);
          const now = new Date();
          const start = new Date(now.getTime() - minutes * 60 * 1000);
          params.append('startDate', start.toISOString());
        } else if (state.globalDateRange.startDate || state.globalDateRange.endDate) {
          // For custom range, use the stored values
          if (state.globalDateRange.startDate) {
            const startDate = new Date(state.globalDateRange.startDate).toISOString();
            params.append('startDate', startDate);
          }
          
          if (state.globalDateRange.endDate) {
            const endDate = new Date(state.globalDateRange.endDate).toISOString();
            params.append('endDate', endDate);
          }
        } else {
          // Fallback to the step-specific filter inputs
          const startDateInput = document.getElementById('step-start-date');
          const endDateInput = document.getElementById('step-end-date');
          const timePresetSelect = document.getElementById('time-preset-select');
          
          if (timePresetSelect.value !== "custom") {
            // If a preset is selected, calculate the start date
            const minutes = parseInt(timePresetSelect.value, 10);
            const now = new Date();
            const start = new Date(now.getTime() - minutes * 60 * 1000);
            params.append('startDate', start.toISOString());
          } else {
            // For custom range, use the visible input values
            if (startDateInput.value && endDateInput.value) {
              const startDate = new Date(startDateInput.value).toISOString();
              const endDate = new Date(endDateInput.value).toISOString();
              params.append('startDate', startDate);
              params.append('endDate', endDate);
            } else if (startDateInput.value) {
              // If only start date is provided, use it
              const startDate = new Date(startDateInput.value).toISOString();
              params.append('startDate', startDate);
            }
          }
        }
        
        if (params.toString()) {
          url += `?${params.toString()}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        // Check if we have the new response format with stats
        const hasStats = data && data.stats;
        const instances = hasStats ? data.timeSeries : data;
        
        if (!instances || !instances.length) {
          stepStatsTable.innerHTML = '<tr><td colspan="4" class="text-center py-4">No instances found</td></tr>';
          stepStatsSummary.classList.add('d-none');
          document.getElementById('step-time-series-chart-container').classList.add('d-none');
          return;
        }
        
        // Display statistics if available
        if (hasStats) {
          // Update statistics display
          document.getElementById('stats-total-executions').textContent = data.stats.totalExecutions;
          document.getElementById('stats-success-count').textContent = data.stats.successCount;
          document.getElementById('stats-error-count').textContent = data.stats.errorCount;
          document.getElementById('stats-avg-duration').textContent = formatDuration(data.stats.avgDuration);
          document.getElementById('stats-min-duration').textContent = formatDuration(data.stats.minDuration);
          document.getElementById('stats-max-duration').textContent = formatDuration(data.stats.maxDuration);
          
          // Show the stats summary section
          stepStatsSummary.classList.remove('d-none');
        } else {
          // Hide stats if not available
          stepStatsSummary.classList.add('d-none');
        }
        
        // Process data for chart
        const timeRange = {
          startDate: params.get('startDate'),
          endDate: params.get('endDate')
        };
        const chartData = processTimeSeriesDataForChart(instances, timeRange);
        
        // Draw the chart
        drawStepTimeSeriesChart(chartData);
        
        // Populate the table with instances
        stepStatsTable.innerHTML = '';
        
        instances.forEach(instance => {
          const timestamp = formatDateTime(instance.timestamp);
          const duration = formatDuration(instance.duration);
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${timestamp}</td>
            <td>${instance.runId}</td>
            <td>${instance.stepKey}</td>
            <td>${duration}</td>
          `;
          
          // Add click event listener to the Run ID link
          const runIdLink = row.querySelector('td:nth-child(2)');
          runIdLink.style.cursor = 'pointer';
          runIdLink.style.color = 'var(--primary)';
          runIdLink.addEventListener('click', (e) => {
            e.preventDefault();
            showRunDetails(instance.runId);
          });
          
          stepStatsTable.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading step stats:', error);
        stepStatsTable.innerHTML = '<tr><td colspan="4" class="text-center py-4">Error loading stats</td></tr>';
        document.getElementById('step-stats-summary').classList.add('d-none');
        document.getElementById('step-time-series-chart-container').classList.add('d-none');
      }
    }

    // Initialize the dashboard
    function initDashboard() {
      // Check URL parameters on load
      const params = new URLSearchParams(window.location.search);
      const pipeline = params.get('pipeline');
      const view = params.get('view');
      const runId = params.get('runId');
      const stepKey = params.get('stepKey');
      const stepName = params.get('stepName');
      
      // Fetch pipelines
      fetchPipelines().then(() => {
        // Set the pipeline from URL if available
        if (pipeline) {
          globalPipelineSelect.value = pipeline;
          state.selectedPipeline = pipeline;
          
          // Load data based on the selected pipeline
          if (state.currentView === 'runs-view') {
            loadRuns(pipeline);
          } else if (state.currentView === 'step-stats-view') {
            loadStepNames(pipeline).then(() => {
              // If stepName is in URL, select it and load its data
              if (stepName) {
                stepNameSelect.value = stepName;
                state.selectedStepName = stepName;
                loadStepTimeSeries(pipeline, stepName);
              }
            });
          }
        }
      });
      
      // Handle view navigation from URL
      if (view) {
        if (view === 'run-detail' && runId) {
          state.selectedRun = runId;
          showView('run-detail-view');
          loadRunDetails(runId, false);
        } else if (view === 'step-analysis' && runId && stepKey) {
          state.selectedRun = runId;
          // We need to find the step data
          fetch(`/api/runs/${runId}/step/${stepKey}`)
            .then(response => response.json())
            .then(step => {
              state.selectedStep = step;
              showView('step-analysis-view');
              stepAnalysisDetails.innerHTML = `
                <p><strong>Step Key:</strong> ${step.key}</p>
                <p><strong>Start Time:</strong> ${formatDateTime(step.time.startTs)}</p>
                <p><strong>End Time:</strong> ${formatDateTime(step.time.endTs)}</p>
                <p><strong>Duration:</strong> ${formatDuration(step.time.timeUsageMs)}</p>
              `;
            });
        } else {
          showView(view);
        }
      }
      
      // Set up global pipeline selector
      globalPipelineSelect.addEventListener('change', function() {
        const pipeline = this.value;
        if (pipeline) {
          state.selectedPipeline = pipeline;
          
          // Update URL with selected pipeline
          const url = new URL(window.location);
          url.searchParams.set('pipeline', pipeline);
          window.history.replaceState({view: state.currentView, pipeline}, '', url);
          
          // Load data based on current view
          if (state.currentView === 'runs-view') {
            loadRuns(pipeline);
          } else if (state.currentView === 'step-stats-view') {
            loadStepNames(pipeline);
            // Clear step name selection
            stepNameSelect.innerHTML = '<option value="">Select a step</option>';
            state.selectedStepName = null;
          } else if (state.currentView === 'run-detail-view') {
            // Stay on current run detail, no need to reload
          }
          
          // Start auto-refresh if enabled
          if (state.autoRefresh && state.currentView === 'runs-view') {
            startAutoRefresh();
          }
        }
      });
      
      // Set up filter buttons
      document.getElementById('global-apply-filter').addEventListener('click', function() {
        // Get values from the global date range selector
        const timePreset = document.getElementById('global-time-preset-select').value;
        const startDate = document.getElementById('global-start-date').value;
        const endDate = document.getElementById('global-end-date').value;
        
        // Update global date range state
        state.globalDateRange.timePreset = timePreset;
        state.globalDateRange.startDate = startDate;
        state.globalDateRange.endDate = endDate;
        
        // Apply the filter based on current view
        if (state.currentView === 'runs-view' && state.selectedPipeline) {
          loadRuns(state.selectedPipeline);
        } else if (state.currentView === 'step-stats-view' && state.selectedPipeline && state.selectedStepName) {
          loadStepTimeSeries(state.selectedPipeline, state.selectedStepName);
        }
      });
      
      // Set default date range (last 24 hours)
      const now = new Date();
      const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      
      // Initialize time range presets
      initTimePresets();
      
      // Set initial state of refresh interval dropdown based on auto-refresh checkbox
      globalRefreshIntervalSelect.disabled = !globalAutoRefreshCheckbox.checked;
      
      // Set initial state of refresh indicator based on auto-refresh state
      refreshIndicator.classList.toggle('active', state.autoRefresh);
      
      // Set up step name selector
      stepNameSelect.addEventListener('change', function() {
        const stepName = this.value;
        if (stepName && state.selectedPipeline) {
          state.selectedStepName = stepName;
          
          // Update URL with selected step name
          const url = new URL(window.location);
          url.searchParams.set('stepName', stepName);
          window.history.replaceState({
            view: state.currentView, 
            pipeline: state.selectedPipeline,
            stepName: stepName
          }, '', url);
          
          // Load step instances when a step is selected
          loadStepTimeSeries(state.selectedPipeline, stepName);
        } else {          
          // If no step is selected, remove the stepName parameter from URL
          const url = new URL(window.location);
          url.searchParams.delete('stepName');
          window.history.replaceState({
            view: state.currentView,
            pipeline: state.selectedPipeline
          }, '', url);
        }
      });
      
      // Initialize date pickers
      initDatePickers();
    }
    
    // Call initialization function when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', initDashboard);

    function initDatePickers() {
      // Check if Flatpickr is loaded
      if (typeof flatpickr === 'function') {
        console.log('Flatpickr is loaded correctly');
        
        // Flag to track if changes are programmatic
        let isProgrammaticChange = false;
        
        // Initialize global date pickers with Flatpickr
        const globalStartDatePicker = flatpickr("#global-start-date", {
          enableTime: true,
          dateFormat: "Y-m-d H:i:S",
          time_24hr: true,
          defaultDate: new Date(Date.now() - 24 * 60 * 60 * 1000), // 24 hours ago
          onChange: function(selectedDates, dateStr) {
            // Only change to Custom if the user manually selected a date
            if (!isProgrammaticChange && dateStr !== "") {
              document.getElementById('global-time-preset-select').value = "custom";
            }
          }
        });
        
        const globalEndDatePicker = flatpickr("#global-end-date", {
          enableTime: true,
          dateFormat: "Y-m-d H:i:S",
          time_24hr: true,
          defaultDate: new Date(), // now
          onChange: function(selectedDates, dateStr) {
            // Only change to Custom if the user manually selected a date
            if (!isProgrammaticChange && dateStr !== "") {
              document.getElementById('global-time-preset-select').value = "custom";
            }
          }
        });
        
        // Initialize step-specific date pickers (keep for backward compatibility)
        const startDatePicker = flatpickr("#step-start-date", {
          enableTime: true,
          dateFormat: "Y-m-d H:i:S",
          time_24hr: true,
          defaultDate: new Date(Date.now() - 24 * 60 * 60 * 1000), // 24 hours ago
          onChange: function(selectedDates, dateStr) {
            // Only change to Custom if the user manually selected a date
            // (not when we programmatically clear it)
            if (!isProgrammaticChange && dateStr !== "") {
              document.getElementById('time-preset-select').value = "custom";
            }
          }
        });
        
        const endDatePicker = flatpickr("#step-end-date", {
          enableTime: true,
          dateFormat: "Y-m-d H:i:S",
          time_24hr: true,
          defaultDate: new Date(), // now
          onChange: function(selectedDates, dateStr) {
            // Only change to Custom if the user manually selected a date
            // (not when we programmatically clear it)
            if (!isProgrammaticChange && dateStr !== "") {
              document.getElementById('time-preset-select').value = "custom";
            }
          }
        });
        
        console.log('Date pickers initialized:', globalStartDatePicker, globalEndDatePicker, startDatePicker, endDatePicker);
        
        // Initialize global time preset dropdown
        const globalTimePresetSelect = document.getElementById('global-time-preset-select');
        globalTimePresetSelect.addEventListener('change', function() {
          // Skip if "Custom" is selected
          if (this.value === "custom") {
            return;
          }
          
          // For preset selections, clear both date pickers visually
          isProgrammaticChange = true; // Set flag before clearing
          globalStartDatePicker.clear();
          globalEndDatePicker.clear();
          isProgrammaticChange = false; // Reset flag after clearing
          
          // Store the preset value in state
          state.globalDateRange.timePreset = this.value;
          state.globalDateRange.startDate = null;
          state.globalDateRange.endDate = null;
          
          // Store the actual start date in a data attribute for API requests
          const minutes = parseInt(this.value, 10);
          const now = new Date();
          const start = new Date(now.getTime() - minutes * 60 * 1000);
          document.getElementById('global-start-date').setAttribute('data-preset-value', start.toISOString());
        });
        
        // Initialize step-specific time preset dropdown (keep for backward compatibility)
        const timePresetSelect = document.getElementById('time-preset-select');
        timePresetSelect.addEventListener('change', function() {
          // Skip if "Custom" is selected
          if (this.value === "custom") {
            return;
          }
          
          // For preset selections, clear both date pickers visually
          isProgrammaticChange = true; // Set flag before clearing
          startDatePicker.clear();
          endDatePicker.clear();
          isProgrammaticChange = false; // Reset flag after clearing
          
          // Store the actual start date in a data attribute for API requests
          const minutes = parseInt(this.value, 10);
          const now = new Date();
          const start = new Date(now.getTime() - minutes * 60 * 1000);
          document.getElementById('step-start-date').setAttribute('data-preset-value', start.toISOString());
          
          // If a step is selected, automatically apply the filter
          if (state.selectedStepName) {
            document.getElementById('apply-step-filter').click();
          }
        });
        
        // Set default value to 24 hours (1440 minutes)
        timePresetSelect.value = "1440";
        globalTimePresetSelect.value = "1440";
        
        // Trigger the change event to set up the initial state
        const event = new Event('change');
        timePresetSelect.dispatchEvent(event);
        globalTimePresetSelect.dispatchEvent(event);
        
        // Add event listener for global apply filter button
        document.getElementById('global-apply-filter').addEventListener('click', function() {
          // Get the date values
          if (globalTimePresetSelect.value === "custom") {
            state.globalDateRange.startDate = document.getElementById('global-start-date').value;
            state.globalDateRange.endDate = document.getElementById('global-end-date').value;
            state.globalDateRange.timePreset = "custom";
          } else {
            state.globalDateRange.timePreset = globalTimePresetSelect.value;
            state.globalDateRange.startDate = null;
            state.globalDateRange.endDate = null;
          }
          
          // Apply the filter based on current view
          if (state.currentView === 'runs-view' && state.selectedPipeline) {
            loadRuns(state.selectedPipeline);
          } else if (state.currentView === 'step-stats-view' && state.selectedPipeline && state.selectedStepName) {
            loadStepTimeSeries(state.selectedPipeline, state.selectedStepName);
          }
        });
      } else {
        console.error('Flatpickr is not loaded!');
      }
    }

    // Initialize time range preset dropdown
    function initTimePresets() {
      const presetSelect = document.getElementById('global-time-preset-select');
      
      // We don't need to add event listeners here as they're handled in initDatePickers
      
      // Set default value to 24 hours (1440 minutes)
      presetSelect.value = "1440";
      
      // Trigger the change event to set up the initial state
      const event = new Event('change');
      presetSelect.dispatchEvent(event);
    }
  </script>
</body>
</html>