<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StepsTrack Dashboard</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Custom CSS -->
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --sidebar-bg: #2c3e50;
      --sidebar-width: 250px;
    }
    
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
    }
    
    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--sidebar-bg);
      color: white;
      position: fixed;
      height: 100vh;
      z-index: 1000;
      padding-top: 1.5rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar-header {
      padding: 0 1.5rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1.5rem;
    }
    
    .sidebar-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #ecf0f1;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.7);
      border-left: 3px solid transparent;
      padding: 0.75rem 1.5rem;
      transition: all 0.2s ease;
    }
    
    .nav-link:hover {
      color: white;
      background-color: rgba(255,255,255,0.1);
    }
    
    .nav-link.active {
      color: white;
      background-color: rgba(255,255,255,0.1);
      border-left: 3px solid var(--primary);
    }
    
    /* Content area */
    .content-area {
      margin-left: var(--sidebar-width);
      padding: 2rem;
      width: calc(100% - var(--sidebar-width));
      max-width: 100%;
    }
    
    /* Cards */
    .card {
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
      margin-bottom: 1.5rem;
      width: 100%;
    }
    
    .card-header {
      background-color: white;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 1.25rem 1.5rem;
    }
    
    .card-body {
      padding: 1.5rem;
    }
    
    /* Tables */
    .table {
      margin-bottom: 0;
    }
    
    .table th {
      font-weight: 600;
      color: #495057;
      border-top: none;
      background-color: #f8f9fa;
    }
    
    .table td {
      vertical-align: middle;
    }
    
    .table-hover tbody tr {
      cursor: pointer;
    }
    
    /* Status indicators */
    .status-success {
      color: #28a745;
    }
    
    .status-error {
      color: #dc3545;
    }
    
    .status-running {
      color: #ffc107;
    }
    
    /* Step details */
    .step-details {
      background-color: #f8f9fa;
      border-radius: 0.375rem;
      padding: 1.25rem;
      margin: 0.75rem 0;
      border-left: 4px solid var(--primary);
    }
    
    .detail-section {
      margin-bottom: 1.25rem;
    }
    
    .detail-section:last-child {
      margin-bottom: 0;
    }
    
    .detail-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .detail-header h5 {
      margin: 0;
      margin-right: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .copy-btn {
      background: none;
      border: none;
      color: var(--primary);
      padding: 0.25rem;
      font-size: 0.875rem;
    }
    
    .detail-content textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.875rem;
      line-height: 1.5;
      resize: vertical;
    }
    
    /* Refresh indicator */
    .refresh-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #28a745;
      margin-right: 0.375rem;
    }
    
    .refresh-indicator.active {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    
    /* Views */
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      
      .content-area {
        margin-left: 0;
        width: 100%;
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>StepsTrack</h1>
      </div>
      <nav class="nav flex-column">
        <a href="#" class="nav-link active" data-view="runs-view">Runs</a>
        <a href="#" class="nav-link" data-view="step-listing-view">Steps</a>
      </nav>
    </div>
    
    <!-- Content Area -->
    <div class="content-area">
      <!-- Run Listing View -->
      <div id="runs-view" class="view active">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h3 mb-0">Pipeline Runs</h1>
        </div>
        
        <div class="card">
          <div class="card-body">
            <div class="mb-4 pb-3 border-bottom">
              <div class="row mb-3 align-items-center">
                <div class="col-md-6">
                  <div class="d-flex align-items-center">
                    <label for="pipeline-select" class="me-2">Pipeline:</label>
                    <select id="pipeline-select" class="form-select">
                      <option value="">Select a pipeline</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex align-items-center justify-content-md-end mt-3 mt-md-0">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                      <label class="form-check-label" for="auto-refresh">
                        <span class="refresh-indicator active me-1"></span>
                        Auto-refresh
                      </label>
                    </div>
                    <select id="refresh-interval" class="form-select form-select-sm ms-2" style="width: auto;">
                      <option value="3000">3 sec</option>
                      <option value="10000">10 sec</option>
                      <option value="30000">30 sec</option>
                      <option value="60000">1 min</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="row align-items-center">
                <div class="col-md-8">
                  <div class="d-flex flex-wrap align-items-center">
                    <label for="start-date" class="me-2">From:</label>
                    <input type="datetime-local" id="start-date" class="form-control form-control-sm me-3" style="width: auto;">
                    <label for="end-date" class="me-2">To:</label>
                    <input type="datetime-local" id="end-date" class="form-control form-control-sm me-3" style="width: auto;">
                    <button id="apply-filter" class="btn btn-primary btn-sm">Apply</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="table-responsive">
              <table id="runs-table" class="table table-hover">
                <thead>
                  <tr>
                    <th>Run ID</th>
                    <th>Pipeline</th>
                    <th>Start Time (UTC)</th>
                    <th>End Time (UTC)</th>
                    <th>Duration</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="6" class="text-center py-4">Select a pipeline to view runs</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Run Detail View -->
      <div id="run-detail-view" class="view">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 id="run-detail-title" class="h4 mb-0">Run Details</h1>
        </div>
        
        <div class="card">
          <div class="card-body">
            <button id="back-to-runs" class="btn btn-outline-secondary mb-4">
              <i class="fas fa-arrow-left me-1"></i> Back to Runs
            </button>
            
            <!-- Gantt Chart -->
            <div class="gantt-placeholder p-4 text-center bg-light rounded mb-4">
              <h5 class="text-muted">Loading Gantt Chart...</h5>
            </div>
            
            <!-- Steps Table -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 id="steps-count" class="h5 mb-0">Steps: 0</h3>
            </div>
            
            <div class="table-responsive">
              <table id="steps-table" class="table table-hover">
                <thead>
                  <tr>
                    <th>Step Key</th>
                    <th>Step Name</th>
                    <th>Start Time (UTC)</th>
                    <th>End Time (UTC)</th>
                    <th>Duration</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" class="text-center py-4">Loading steps...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Step Listing View -->
      <div id="step-listing-view" class="view">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h3 mb-0">Step Instances</h1>
        </div>
        
        <div class="card">
          <div class="card-body">
            <div class="mb-4 pb-3 border-bottom">
              <div class="row mb-3 align-items-center">
                <div class="col-md-8">
                  <div class="d-flex flex-wrap align-items-center">
                    <label for="step-pipeline-select" class="me-2">Pipeline:</label>
                    <select id="step-pipeline-select" class="form-select me-3" style="width: auto;">
                      <option value="">Select a pipeline</option>
                    </select>
                    
                    <label for="step-name-select" class="me-2">Step:</label>
                    <select id="step-name-select" class="form-select" style="width: auto;">
                      <option value="">Select a step</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="d-flex align-items-center justify-content-md-end mt-3 mt-md-0">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="step-auto-refresh" checked>
                      <label class="form-check-label" for="step-auto-refresh">
                        <span class="refresh-indicator active me-1"></span>
                        Auto-refresh
                      </label>
                    </div>
                    <select id="step-refresh-interval" class="form-select form-select-sm ms-2" style="width: auto;">
                      <option value="3000">3 sec</option>
                      <option value="10000">10 sec</option>
                      <option value="30000">30 sec</option>
                      <option value="60000">1 min</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="row align-items-center">
                <div class="col-md-8">
                  <div class="d-flex flex-wrap align-items-center">
                    <label for="step-start-date" class="me-2">From:</label>
                    <input type="datetime-local" id="step-start-date" class="form-control form-control-sm me-3" style="width: auto;">
                    <label for="step-end-date" class="me-2">To:</label>
                    <input type="datetime-local" id="step-end-date" class="form-control form-control-sm me-3" style="width: auto;">
                    <button id="apply-step-filter" class="btn btn-primary btn-sm">Apply</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="table-responsive">
              <table id="step-instances-table" class="table table-hover">
                <thead>
                  <tr>
                    <th>Timestamp (UTC)</th>
                    <th>Run ID</th>
                    <th>Duration</th>
                    <th>Step Key</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="4" class="text-center py-4">Select a pipeline and step to view instances</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Step Analysis View -->
      <div id="step-analysis-view" class="view">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 id="step-analysis-title" class="h4 mb-0">Step Analysis</h1>
        </div>
        
        <div class="card">
          <div class="card-body">
            <button id="back-to-run-detail" class="btn btn-outline-secondary mb-4">
              <i class="fas fa-arrow-left me-1"></i> Back to Run Detail
            </button>
            
            <div class="step-analysis-content">
              <h4 class="mb-3">Performance Over Time</h4>
              <div class="chart-placeholder p-4 text-center bg-light rounded mb-4">
                <p class="text-muted mb-0">Performance chart will be implemented here</p>
              </div>
              
              <h4 class="mb-3">Step Details</h4>
              <pre id="step-analysis-details" class="bg-light p-3 rounded"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // State management
    const state = {
      currentView: 'runs-view',
      selectedPipeline: null,
      selectedRun: null,
      selectedStep: null,
      selectedStepName: null,
      autoRefresh: {
        runs: true,
        steps: true
      },
      refreshIntervals: {
        runs: null,
        steps: null
      },
      refreshFrequency: {
        runs: 3000,
        steps: 3000
      },
      expandedRows: new Set() // Track expanded rows
    };

    // DOM Elements
    const navLinks = document.querySelectorAll('.nav-link');
    const views = document.querySelectorAll('.view');
    const pipelineSelect = document.getElementById('pipeline-select');
    const stepPipelineSelect = document.getElementById('step-pipeline-select');
    const stepNameSelect = document.getElementById('step-name-select');
    const runsTable = document.getElementById('runs-table').querySelector('tbody');
    const stepsTable = document.getElementById('steps-table').querySelector('tbody');
    const stepInstancesTable = document.getElementById('step-instances-table').querySelector('tbody');
    const backToRunsBtn = document.getElementById('back-to-runs');
    const backToRunDetailBtn = document.getElementById('back-to-run-detail');
    const runDetailTitle = document.getElementById('run-detail-title');
    const stepAnalysisTitle = document.getElementById('step-analysis-title');
    const stepAnalysisDetails = document.getElementById('step-analysis-details');
    const autoRefreshCheckbox = document.getElementById('auto-refresh');
    const stepAutoRefreshCheckbox = document.getElementById('step-auto-refresh');
    const refreshIntervalSelect = document.getElementById('refresh-interval');
    const stepRefreshIntervalSelect = document.getElementById('step-refresh-interval');
    const refreshIndicators = document.querySelectorAll('.refresh-indicator');

    // Helper functions
    function formatDateTime(timestamp) {
      if (!timestamp) return 'N/A';
      
      const date = new Date(timestamp);
      return date.toISOString().replace('T', ' ').substring(0, 19);
    }
    
    function formatDuration(ms) {
      if (!ms) return 'N/A';
      
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      
      if (hours > 0) {
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
      } else {
        return `${seconds}s`;
      }
    }

    // Navigation functions
    function showRunDetails(runId) {
      // Reset expanded rows when navigating to a different run
      if (state.selectedRun !== runId) {
        state.expandedRows = new Set();
      }
      
      state.selectedRun = runId;
      
      // Switch to run detail view
      document.getElementById('runs-view').classList.remove('active');
      document.getElementById('run-detail-view').classList.add('active');
      
      // Load run details (not an auto-refresh)
      loadRunDetails(runId, false);
    }
    
    function showStepAnalysis(step) {
      state.selectedStep = step;
      
      // Switch to step analysis view
      document.getElementById('run-detail-view').classList.remove('active');
      document.getElementById('step-analysis-view').classList.add('active');
      
      // Update title and details
      stepAnalysisTitle.textContent = `Step Analysis: ${step.name}`;
      stepAnalysisDetails.innerHTML = `
        <p><strong>Step Key:</strong> ${step.key}</p>
        <p><strong>Start Time:</strong> ${formatDateTime(step.time.startTs)}</p>
        <p><strong>End Time:</strong> ${formatDateTime(step.time.endTs)}</p>
        <p><strong>Duration:</strong> ${formatDuration(step.time.timeUsageMs)}</p>
      `;
    }

    // Navigation
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const viewId = link.getAttribute('data-view');
        
        // Update active link
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        // Show selected view
        views.forEach(view => {
          view.classList.remove('active');
          if (view.id === viewId) {
            view.classList.add('active');
            state.currentView = viewId;
          }
        });
      });
    });

    // Back buttons
    backToRunsBtn.addEventListener('click', () => {
      document.getElementById('runs-view').classList.add('active');
      document.getElementById('run-detail-view').classList.remove('active');
      
      // Reset expanded rows state when exiting run detail view
      state.expandedRows = new Set();
      state.selectedRun = null;
    });

    backToRunDetailBtn.addEventListener('click', () => {
      document.getElementById('run-detail-view').classList.add('active');
      document.getElementById('step-analysis-view').classList.remove('active');
      state.selectedStep = null;
    });

    // Auto-refresh toggles
    autoRefreshCheckbox.addEventListener('change', function() {
      state.autoRefresh.runs = this.checked;
      refreshIndicators[0].classList.toggle('active', this.checked);
      
      if (this.checked) {
        startAutoRefresh('runs');
      } else {
        stopAutoRefresh('runs');
      }
    });

    stepAutoRefreshCheckbox.addEventListener('change', function() {
      state.autoRefresh.steps = this.checked;
      refreshIndicators[1].classList.toggle('active', this.checked);
      
      if (this.checked) {
        startAutoRefresh('steps');
      } else {
        stopAutoRefresh('steps');
      }
    });

    // Refresh interval change handlers
    refreshIntervalSelect.addEventListener('change', function() {
      state.refreshFrequency.runs = parseInt(this.value);
      if (state.autoRefresh.runs) {
        startAutoRefresh('runs');
      }
    });

    stepRefreshIntervalSelect.addEventListener('change', function() {
      state.refreshFrequency.steps = parseInt(this.value);
      if (state.autoRefresh.steps) {
        startAutoRefresh('steps');
      }
    });

    // Auto-refresh functions
    function startAutoRefresh(type) {
      stopAutoRefresh(type); // Clear any existing interval
      
      if (type === 'runs') {
        state.refreshIntervals.runs = setInterval(() => {
          if (state.selectedRun) {
            // Save expanded state before auto-refresh
            const expandedRows = new Set();
            document.querySelectorAll('.details-row').forEach(row => {
              if (row.style.display !== 'none') {
                expandedRows.add(row.id);
              }
            });
            state.expandedRows = expandedRows;
            
            // Pass true to indicate this is an auto-refresh
            loadRunDetails(state.selectedRun, true);
          } else if (state.selectedPipeline) {
            loadRuns(state.selectedPipeline);
          }
        }, state.refreshFrequency.runs);
      } else if (type === 'steps') {
        state.refreshIntervals.steps = setInterval(() => {
          if (state.selectedPipeline && state.selectedStepName) {
            loadStepInstances(state.selectedPipeline, state.selectedStepName);
          }
        }, state.refreshFrequency.steps);
      }
    }

    function stopAutoRefresh(type) {
      if (state.refreshIntervals[type]) {
        clearInterval(state.refreshIntervals[type]);
        state.refreshIntervals[type] = null;
      }
    }

    // API functions
    async function fetchPipelines() {
      try {
        console.log('Fetching pipelines...');
        const response = await fetch('/api/pipelines');
        const pipelines = await response.json();
        console.log('Pipelines fetched:', pipelines);
        
        // Populate pipeline dropdowns
        pipelineSelect.innerHTML = '<option value="">Select a pipeline</option>';
        stepPipelineSelect.innerHTML = '<option value="">Select a pipeline</option>';
        
        pipelines.forEach(pipeline => {
          pipelineSelect.innerHTML += `<option value="${pipeline}">${pipeline}</option>`;
          stepPipelineSelect.innerHTML += `<option value="${pipeline}">${pipeline}</option>`;
        });
      } catch (error) {
        console.error('Error fetching pipelines:', error);
        pipelineSelect.innerHTML = '<option value="">Error loading pipelines</option>';
        stepPipelineSelect.innerHTML = '<option value="">Error loading pipelines</option>';
      }
    }

    async function loadRuns(pipeline) {
      try {
        // Get filter values
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Build query parameters
        let url = `/api/runs/${pipeline}`;
        const params = new URLSearchParams();
        
        if (startDate) {
          params.append('startDate', startDate);
        }
        
        if (endDate) {
          params.append('endDate', endDate);
        }
        
        if (params.toString()) {
          url += `?${params.toString()}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (!result?.runs?.length) {
          runsTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">No runs found</td></tr>';
          return;
        }

        runsTable.innerHTML = '';
        result.runs.forEach(run => {
          const startTime = formatDateTime(run.startTime);
          const endTime = run.endTime ? formatDateTime(run.endTime) : 'In progress';
          const duration = formatDuration(run.duration);
          
          let statusClass = '';
          if (run.status === 'completed') {
            statusClass = 'status-success';
          } else if (run.status === 'failed') {
            statusClass = 'status-error';
          } else if (run.status === 'running') {
            statusClass = 'status-running';
          }
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${run.runId}</td>
            <td>${run.pipeline}</td>
            <td>${startTime}</td>
            <td>${endTime}</td>
            <td>${duration}</td>
            <td class="${statusClass}">${run.status}</td>
          `;
          
          row.addEventListener('click', () => {
            showRunDetails(run.runId);
          });
          
          runsTable.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading runs:', error);
        runsTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Error loading runs</td></tr>';
      }
    }

    async function loadRunDetails(runId, isAutoRefresh = false) {
      try {
        // Only save expanded state if this is an auto-refresh
        if (isAutoRefresh) {
          const expandedRows = new Set();
          document.querySelectorAll('.details-row').forEach(row => {
            if (row.style.display !== 'none') {
              expandedRows.add(row.id);
            }
          });
          state.expandedRows = expandedRows;
        }
        
        const response = await fetch(`/api/run/${runId}`);
        const data = await response.json();
        
        // Update title
        runDetailTitle.textContent = `Run Details: ${runId}`;
        
        // Load Gantt chart
        loadGanttChart(runId);
        
        // Update steps count
        const stepsCount = data.steps ? data.steps.length : 0;
        document.getElementById('steps-count').textContent = `Steps: ${stepsCount}`;
        
        // Load steps
        if (data.steps && Array.isArray(data.steps)) {
          stepsTable.innerHTML = '';
          
          data.steps.forEach((step, index) => {
            const startTime = formatDateTime(step.time.startTs);
            const endTime = formatDateTime(step.time.endTs);
            const duration = formatDuration(step.time.timeUsageMs);
            
            let status = 'Completed';
            let statusClass = 'status-success';
            
            if (step.error) {
              status = 'Error';
              statusClass = 'status-error';
            } else if (step.time.endTs === 0) {
              status = 'Running';
              statusClass = 'status-running';
            }
            
            // Create unique IDs for each row and details section
            const rowId = `step-row-${index}`;
            const detailsId = `step-details-${index}`;
            
            // Main row
            const row = document.createElement('tr');
            row.id = rowId;
            row.setAttribute('data-target', detailsId);
            row.innerHTML = `
              <td>${step.key}</td>
              <td><a href="#" class="step-name-link">${step.name}</a></td>
              <td>${startTime}</td>
              <td>${endTime}</td>
              <td>${duration}</td>
              <td class="${statusClass}">${status}</td>
              <td class="text-center"><i class="fas fa-chevron-down expand-icon"></i></td>
            `;
            stepsTable.appendChild(row);
            
            // Details row
            const detailsRow = document.createElement('tr');
            detailsRow.id = detailsId;
            detailsRow.className = 'details-row';
            
            // Check if this row was expanded before refresh
            const wasExpanded = state.expandedRows.has(detailsId);
            detailsRow.style.display = wasExpanded ? 'table-row' : 'none';
            
            // Update expand icon based on expanded state
            if (wasExpanded) {
              row.querySelector('.expand-icon').classList.remove('fa-chevron-down');
              row.querySelector('.expand-icon').classList.add('fa-chevron-up');
            }
            
            // Create the details cell
            const detailsCell = document.createElement('td');
            detailsCell.colSpan = 7;
            
            let detailsContent = '<div class="step-details">';
            
            // Record section
            const recordJson = JSON.stringify(step.record || {}, null, 2);
            detailsContent += `
              <div class="detail-section">
                <div class="detail-header">
                  <h4>Record:</h4>
                  <button class="copy-btn" data-content="${encodeURIComponent(recordJson)}">
                    <i class="fa fa-copy"></i>
                  </button>
                </div>
                <div class="detail-content">
                  <textarea readonly>${recordJson}</textarea>
                </div>
              </div>
            `;
            
            // Result section (if available)
            if (step.result !== undefined) {
              const resultJson = JSON.stringify(step.result, null, 2);
              detailsContent += `
                <div class="detail-section">
                  <div class="detail-header">
                    <h4>Result:</h4>
                    <button class="copy-btn" data-content="${encodeURIComponent(resultJson)}">
                      <i class="fa fa-copy"></i>
                    </button>
                  </div>
                  <div class="detail-content">
                    <textarea readonly>${resultJson}</textarea>
                  </div>
                </div>
              `;
            }
            
            // Error section (if available)
            if (step.error) {
              detailsContent += `
                <div class="detail-section">
                  <div class="detail-header">
                    <h4>Error:</h4>
                    <button class="copy-btn" data-content="${encodeURIComponent(step.error)}">
                      <i class="fa fa-copy"></i>
                    </button>
                  </div>
                  <div class="detail-content">
                    <textarea readonly>${step.error}</textarea>
                  </div>
                </div>
              `;
            }
            
            detailsContent += '</div>';
            detailsCell.innerHTML = detailsContent;
            detailsRow.appendChild(detailsCell);
            stepsTable.appendChild(detailsRow);
            
            // Add step name link functionality
            const stepNameLink = row.querySelector('.step-name-link');
            stepNameLink.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              showStepAnalysis(step);
            });
          });
          
          // Make rows clickable to expand/collapse
          document.querySelectorAll('#steps-table tbody tr:not(.details-row)').forEach(row => {
            row.addEventListener('click', function(e) {
              // Don't trigger if clicking on the step name link
              if (e.target.closest('.step-name-link')) {
                return;
              }
              
              const targetId = this.getAttribute('data-target');
              const detailsRow = document.getElementById(targetId);
              const isExpanded = detailsRow.style.display !== 'none';
              const expandIcon = this.querySelector('.expand-icon');
              
              // Update expanded state in our state object
              if (isExpanded) {
                state.expandedRows.delete(targetId);
                expandIcon.classList.remove('fa-chevron-up');
                expandIcon.classList.add('fa-chevron-down');
              } else {
                state.expandedRows.add(targetId);
                expandIcon.classList.remove('fa-chevron-down');
                expandIcon.classList.add('fa-chevron-up');
              }
              
              detailsRow.style.display = isExpanded ? 'none' : 'table-row';
            });
          });
          
          // Add event listeners for all copy buttons
          document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
              e.stopPropagation(); // Prevent row expansion when clicking copy
              const content = decodeURIComponent(this.getAttribute('data-content'));
              navigator.clipboard.writeText(content).then(() => {
                // Show temporary success message
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fa fa-check"></i>';
                setTimeout(() => {
                  this.innerHTML = originalText;
                }, 2000);
              }).catch(err => {
                console.error('Failed to copy text: ', err);
              });
            });
          });
        } else {
          stepsTable.innerHTML = '<tr><td colspan="7" class="text-center py-4">No steps found</td></tr>';
        }
      } catch (error) {
        console.error('Error loading run details:', error);
        stepsTable.innerHTML = '<tr><td colspan="7" class="text-center py-4">Error loading run details</td></tr>';
      }
    }

    async function loadGanttChart(runId) {
      try {
        const ganttPlaceholder = document.querySelector('.gantt-placeholder');
        
        // Show loading state
        ganttPlaceholder.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading Gantt Chart...</p></div>';
        
        // Fetch the Gantt chart URL
        const response = await fetch(`/api/charts/gantt/${runId}`);
        const data = await response.json();
        
        if (data.url) {
          // Replace placeholder with the actual chart
          ganttPlaceholder.innerHTML = `
            <img src="${data.url}" alt="Gantt Chart" class="img-fluid">
          `;
        } else {
          ganttPlaceholder.innerHTML = '<div class="alert alert-warning">Gantt Chart Unavailable</div>';
        }
      } catch (error) {
        console.error('Error loading Gantt chart:', error);
        document.querySelector('.gantt-placeholder').innerHTML = '<div class="alert alert-danger">Error Loading Gantt Chart</div>';
      }
    }

    async function loadStepNames(pipeline) {
      try {
        const response = await fetch(`/api/steps/${pipeline}`);
        const steps = await response.json();
        
        stepNameSelect.innerHTML = '<option value="">Select a step</option>';
        
        steps.forEach(step => {
          stepNameSelect.innerHTML += `<option value="${step}">${step}</option>`;
        });
      } catch (error) {
        console.error('Error loading step names:', error);
        stepNameSelect.innerHTML = '<option value="">Error loading steps</option>';
      }
    }

    async function loadStepInstances(pipeline, stepName) {
      try {
        // Get filter values
        const startDate = document.getElementById('step-start-date').value;
        const endDate = document.getElementById('step-end-date').value;
        
        // Build query parameters
        let url = `/api/step-instances/${pipeline}/${stepName}`;
        const params = new URLSearchParams();
        
        if (startDate) {
          params.append('startDate', startDate);
        }
        
        if (endDate) {
          params.append('endDate', endDate);
        }
        
        if (params.toString()) {
          url += `?${params.toString()}`;
        }
        
        const response = await fetch(url);
        const instances = await response.json();
        
        if (!instances || !instances.length) {
          stepInstancesTable.innerHTML = '<tr><td colspan="4" class="text-center py-4">No instances found</td></tr>';
          return;
        }
        
        stepInstancesTable.innerHTML = '';
        
        instances.forEach(instance => {
          const timestamp = formatDateTime(instance.timestamp);
          const duration = formatDuration(instance.duration);
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${timestamp}</td>
            <td>${instance.runId}</td>
            <td>${duration}</td>
            <td>${instance.stepKey}</td>
          `;
          
          stepInstancesTable.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading step instances:', error);
        stepInstancesTable.innerHTML = '<tr><td colspan="4" class="text-center py-4">Error loading instances</td></tr>';
      }
    }

    // Initialize the dashboard
    function initDashboard() {
      // Fetch pipelines
      fetchPipelines();
      
      // Set up event listeners
      pipelineSelect.addEventListener('change', function() {
        const pipeline = this.value;
        if (pipeline) {
          state.selectedPipeline = pipeline;
          loadRuns(pipeline);
          
          // Start auto-refresh if enabled
          if (state.autoRefresh.runs) {
            startAutoRefresh('runs');
          }
        }
      });
      
      stepPipelineSelect.addEventListener('change', function() {
        const pipeline = this.value;
        if (pipeline) {
          loadStepNames(pipeline);
        }
      });
      
      stepNameSelect.addEventListener('change', function() {
        const stepName = this.value;
        if (stepName && stepPipelineSelect.value) {
          state.selectedStepName = stepName;
          loadStepInstances(stepPipelineSelect.value, stepName);
          
          // Start auto-refresh if enabled
          if (state.autoRefresh.steps) {
            startAutoRefresh('steps');
          }
        }
      });
      
      // Set up filter buttons
      document.getElementById('apply-filter').addEventListener('click', function() {
        if (state.selectedPipeline) {
          loadRuns(state.selectedPipeline);
        }
      });
      
      document.getElementById('apply-step-filter').addEventListener('click', function() {
        if (state.selectedPipeline && state.selectedStepName) {
          loadStepInstances(state.selectedPipeline, state.selectedStepName);
        }
      });
    }
    
    // Call initialization function when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>